<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Noah Greifer">

<title>Propensity Score Analysis for Medical Research: A Primer and Tutorial - 1&nbsp; Planning the Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./running.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./planning.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Planning the Analysis</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Propensity Score Analysis for Medical Research: A Primer and Tutorial</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./planning.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Planning the Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Running the Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./running.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic Steps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conceptual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Conceptual aspects of the analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conditioning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditioning: matching and weighting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Assessing quality</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./respecification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Respecification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimating.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimating the treatment effect</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sensitivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Sensitivity analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced topics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Reporting the Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Example</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Example Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ex-match.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Matching</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ex-weight.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Weighting</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#types-of-questions-that-can-be-answered" id="toc-types-of-questions-that-can-be-answered" class="nav-link active" data-scroll-target="#types-of-questions-that-can-be-answered"><span class="header-section-number">1.1</span> Types of questions that can be answered</a></li>
  <li><a href="#choosing-an-estimand" id="toc-choosing-an-estimand" class="nav-link" data-scroll-target="#choosing-an-estimand"><span class="header-section-number">1.2</span> Choosing an estimand</a>
  <ul class="collapse">
  <li><a href="#marginal-and-conditional-effects" id="toc-marginal-and-conditional-effects" class="nav-link" data-scroll-target="#marginal-and-conditional-effects"><span class="header-section-number">1.2.1</span> Marginal and conditional effects</a></li>
  <li><a href="#the-target-population" id="toc-the-target-population" class="nav-link" data-scroll-target="#the-target-population"><span class="header-section-number">1.2.2</span> The target population</a></li>
  </ul></li>
  <li><a href="#meeting-assumptions" id="toc-meeting-assumptions" class="nav-link" data-scroll-target="#meeting-assumptions"><span class="header-section-number">1.3</span> Meeting assumptions</a>
  <ul class="collapse">
  <li><a href="#the-backdoor-criterion" id="toc-the-backdoor-criterion" class="nav-link" data-scroll-target="#the-backdoor-criterion"><span class="header-section-number">1.3.1</span> The backdoor criterion</a></li>
  <li><a href="#positivity" id="toc-positivity" class="nav-link" data-scroll-target="#positivity"><span class="header-section-number">1.3.2</span> Positivity</a></li>
  <li><a href="#consistency" id="toc-consistency" class="nav-link" data-scroll-target="#consistency"><span class="header-section-number">1.3.3</span> Consistency</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">1.4</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-planning" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Planning the Analysis</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The “fun” part of propensity score analysis is actually running the code on data, but there are critical decisions that need to be made before doing so. One needs to decide whether propensity score analysis is appropriate for answering the question of interest, what quantity is to be estimated, and whether the assumptions for the analysis can be met. The next sections describe making these decisions.</p>
<section id="types-of-questions-that-can-be-answered" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="types-of-questions-that-can-be-answered"><span class="header-section-number">1.1</span> Types of questions that can be answered</h2>
<p>There are several ways to ask causal questions: one is to ask what are the causes of observed variation in outcomes (e.g., why certain patients experience remission and others don’t), and another is to ask what the causal effect of one variable is on an outcome (e.g., whether taking aspirin reduces heart attack risk). Propensity score analysis is only appropriate for answering the second type of question, i.e., “What is the effect of a treatment on an outcome?” It is not useful for discovering predictors of an outcome, for developing clinical prediction models, for identifying which variables are important drivers of the outcome, etc. To perform propensity score analysis, one must have a <strong>single</strong> well-defined treatment.</p>
<p>The type of quantity propensity score analysis is best suited to answer is the <em>total effect</em> of the treatment on the outcome. The total effect refers to an effect that ignores any intermediate pathways. For example, a drug might affect survival by stimulating the immune response in a patient; propensity score analysis can help answer the question of whether the treatment affects the immune response or whether the treatment affects survival, but it cannot answer the mechanistic question of whether the effect of treatment on the survival is due to its effect on the immune response. That type of question is a “mediation” question, and though propensity score analysis can play a role in such an analysis, in its basic and most common form, it is not able to answer such questions.</p>
<p>Propensity score analysis is sometimes used in disparities research, i.e., to identify whether a disparity exists on a single patient dimension (e.g., sex or race) after controlling for differences in relevant variables between these groups. For example, one might notice that pain management prescription amounts differ between male and female patients with a given diagnosis; propensity score analysis can be used to create groups of male and female patients that look similar on variables that might be relevant to explaining away that disparity, such as age, comorbidities, weight, height, etc., so that the only explanation left for the disparity is a personal bias by prescribing physicians.</p>
<p>This type of analysis has several problems and will not be discussed further here (see <span class="citation" data-cites="huberCausalPitfallsDecomposition2015">Huber (<a href="references.html#ref-huberCausalPitfallsDecomposition2015" role="doc-biblioref">2015</a>)</span> for a discussion of these problems). However, it does identify that propensity score analysis can be used to create comparable groups no matter what those groups are to be used for; the analysis itself is agnostic to how those groups will be compared and whether that comparison represents a valid causal effect or disparity. It is the assumptions behind the analysis that allow for causal inference; these assumptions are described later in this section.</p>
</section>
<section id="choosing-an-estimand" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="choosing-an-estimand"><span class="header-section-number">1.2</span> Choosing an estimand</h2>
<p>An <strong>estimand</strong> is simply the quantity being estimated, i.e., the quantity of interest from a study. Although one might simply say that the estimand is the treatment effect, there are nuances to an estimand that are critical to articulate to be able to validly interpret the resulting estimate and to be able to make choices in the analysis that target the estimand. The concept of an estimand is also present in randomized trials, and many of the considerations for these estimands also apply to those in observational studies, though there are some additional considerations. <span class="citation" data-cites="kahanEliminatingAmbiguousTreatment2023">Kahan et al. (<a href="references.html#ref-kahanEliminatingAmbiguousTreatment2023" role="doc-biblioref">2023</a>)</span> and <span class="citation" data-cites="hanDefiningEstimandsClinical2023">Han and Zhou (<a href="references.html#ref-hanDefiningEstimandsClinical2023" role="doc-biblioref">2023</a>)</span> provide nice overviews of the components of an estimand in clinical trials.</p>
<p>Some components of an estimand common to observational studies and randomized trials include who the effect is estimated for in the presence of noncompliance (e.g., just those who actually received the treatment or all those who were assigned treatment), how the effect is measured (e.g., as a risk ratio, hazard ratio, or odds ratio), the time scale of the outcome (e.g., death at 12 months or 24 months), and how intercurrent events (e.g., death before a non-death clinical endpoint) are incorporated. Two components of an estimand that are particularly important to consider in propensity score analysis are whether the effect is to be marginal or conditional and for which subset of the study population the effect is meant to generalize; we focus on these in this tutorial, but that is not a reason to ignore the others.</p>
<section id="marginal-and-conditional-effects" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="marginal-and-conditional-effects"><span class="header-section-number">1.2.1</span> Marginal and conditional effects</h3>
<p>A marginal effect is a comparison between the expected potential outcome under treatment and the expected potential outcome under control. This is the same quantity estimated in randomized trials without blocking or covariate adjustment and is particularly useful for quantifying the overall effect of a policy or population-wide intervention. A conditional effect is the comparison between the expected potential outcomes in the treatment groups within strata. This is useful for identifying the effect of a treatment for an individual patient or a subset of the population.</p>
<p>Although conditional effects are often more useful for clinical decision-making, they require far stricter assumptions about the relationship between confounders and the outcome and are not well suited for propensity score analysis. Estimating conditional effects either involves performing the analysis within subgroups of the sample (which can dramatically shrink the available data and yield imprecise estimates) or using an outcome model that presupposes a very specific and unrealistic functional form (e.g., using the coefficient on treatment in a logistic regression model with confounders included). We will focus instead on marginal effects, which can be estimated using the full dataset and don’t require such assumptions.</p>
</section>
<section id="the-target-population" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="the-target-population"><span class="header-section-number">1.2.2</span> The target population</h3>
<p>The target population refers to the population to which the effect is meant to generalize. Selecting this population is critical in propensity score analysis because it determines how specific steps of the analysis proceed and how to interpret them. There are four common estimands that can be targeted in propensity score analysis:</p>
<ul>
<li><p>The average treatment effect in the population (ATE) - the average difference in outcomes between a scenario in which all units were treated and a scenario in which no units were treated. This is useful for determining universal policies or broadly understanding the effect of a treatment (e.g., Does this treatment work on average?).</p></li>
<li><p>The average treatment effect in the treated (ATT) - the average difference between the observed outcomes for the treated units and the outcomes the treated units would have had had they not been treated. It can be interpreted as the effect of withholding treatment from those who would otherwise receive it. This is useful for estimating the effects of potentially dangerous exposures or experimental procedures that would be given to patients like those currently receiving it.</p></li>
<li><p>The average treatment effect in the control (ATC) - the average difference between the observed outcomes for the untreated units and the outcomes the untreated units would have had had they been treated. It can be interpreted as the effect of expanding treatment to those who would not otherwise receive it.</p></li>
<li><p>The average treatment effect in the overlap (ATO) - the average difference in outcomes for those at clinical equipoise (i.e., the “overlap” population) were they to receive treatment and were they not to receive treatment. Although the scope of the ATO is limited and sometimes vague (i.e., because there are many ways to statistically define the overlap population), these estimates tend to be the least biased, most precise, and most resistant to biases due to unobserved variables like patient frailty.</p></li>
</ul>
<p>These estimands, a guide of how to choose among them, and the specific techniques that can be used to estimate them are described in detail in <span class="citation" data-cites="greiferChoosingEstimandWhen2021">Greifer and Stuart (<a href="references.html#ref-greiferChoosingEstimandWhen2021" role="doc-biblioref">2021</a>)</span>.</p>
</section>
</section>
<section id="meeting-assumptions" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="meeting-assumptions"><span class="header-section-number">1.3</span> Meeting assumptions</h2>
<p>There are a number of assumptions that are critical to being able to interpret the effects estimated using propensity score analysis as causal. Other methods for estimating causal effects may involve different assumptions; the assumptions listed here apply only to propensity score analysis and other methods of adjustment that rely on adjusting for observed variables, such as regression adjustment <span class="citation" data-cites="matthayAlternativeCausalInference2020">(<a href="references.html#ref-matthayAlternativeCausalInference2020" role="doc-biblioref">Matthay et al. 2020</a>)</span>. If these assumptions are violated, the link between the statistical quantity estimated by propensity score analysis and the causal quantity desired by the researcher is broken.</p>
<p>Propensity score analysis can only be used to estimate causal effects when these assumptions are met. In this sense, propensity score analysis is not a “causal inference method”, it is a method of estimating a statistical quantity (the adjusted association between the treatment and outcome), which can only be interpreted as a causal effect when these assumptions are met. The key assumptions are <strong>satisfaction of the backdoor criterion</strong>, <strong>positivity</strong>, and <strong>consistency</strong>. These are in addition to other assumptions that underlie the methods involved, such as assumptions about missing data if any are present and assumptions about correct measurement of the confounders, treatment, and outcome.</p>
<section id="the-backdoor-criterion" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="the-backdoor-criterion"><span class="header-section-number">1.3.1</span> The backdoor criterion</h3>
<p>The backdoor criterion is that there are no “backdoor paths” from the treatment to the outcome. A backdoor path is a causal chain from the treatment to the outcome through a common cause of the treatment and outcome. Satisfaction of the backdoor criterion means that, conditional on the set of variables to be adjusted for, there are no backdoor paths from the treatment to the outcome, and the only association between the treatment and the outcome is due to the causal effect of the treatment on the outcome. In addition, no variables that induce bias have been adjusted for; these include variables caused by the treatment or the outcome. <span class="citation" data-cites="vanderweelePrinciplesConfounderSelection2019">VanderWeele (<a href="references.html#ref-vanderweelePrinciplesConfounderSelection2019" role="doc-biblioref">2019</a>)</span> provides a clear guide on how to meet this assumption.</p>
<p>Satisfaction of the backdoor criterion is also known as the assumption of “strong ignorability” <span class="citation" data-cites="rosenbaumCentralRolePropensity1983">(<a href="references.html#ref-rosenbaumCentralRolePropensity1983" role="doc-biblioref">Paul R. Rosenbaum and Rubin 1983</a>)</span>, “conditional exchangeability” <span class="citation" data-cites="hernanEstimatingCausalEffects2006">(<a href="references.html#ref-hernanEstimatingCausalEffects2006" role="doc-biblioref">Hernán and Robins 2006</a>)</span>, “selection on observables”, or, simply, no unmeasured confounding. Meeting this assumption requires a researcher to have collected a sufficient set of variables that closes all backdoor paths without opening any biasing paths. This assumption is often considered hard to meet when treatment has not been randomly assigned or the assignment mechanism is unknown, which is why methods that rely on this assumption when used in observational studies are often viewed with suspicion and why claiming causality from observational studies is dangerous.</p>
<p>There are a few strategies for meeting this assumption. One is to include all measured variables in the analysis, hoping that the set of measured variables is sufficient to satisfy the criterion. This is known as the “kitchen sink” approach. When the temporal ordering of the variables is clear (i.e., it can be assured that all of the variables to be adjusted for precede treatment), this can be an effective strategy, especially if many variables jointly act as proxies for possibly unmeasured confounders <span class="citation" data-cites="brookhartConfoundingControlHealthcare2010a">(<a href="references.html#ref-brookhartConfoundingControlHealthcare2010a" role="doc-biblioref">Brookhart et al. 2010</a>)</span>. It is critical that all variables adjusted for are not even possible affected by the treatment or outcome. Another, more principled strategy is to draw a causal diagram, known as a DAG, that represents what is known about the causal system under study and can be used to select the specific variables that are and are not necessary to close all backdoor paths <span class="citation" data-cites="greenlandCausalDiagramsEpidemiologic1999">(<a href="references.html#ref-greenlandCausalDiagramsEpidemiologic1999" role="doc-biblioref">Greenland, Pearl, and Robins 1999</a>)</span>. Either way, researchers must be prepared to justify why they adjusted for the variables they did and why adjustment for these variables is sufficient to satisfy the backdoor criterion.</p>
</section>
<section id="positivity" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="positivity"><span class="header-section-number">1.3.2</span> Positivity</h3>
<p>Positivity is the assumption that all units are eligible to be either treated or untreated <span class="citation" data-cites="westreichInvitedCommentaryPositivity2010">(<a href="references.html#ref-westreichInvitedCommentaryPositivity2010" role="doc-biblioref">Westreich and Cole 2010</a>)</span>. The idea is that if some units are ineligible to be treated, it doesn’t make sense to try to infer what would have happened to them had they been treated.</p>
<p>Positivity is an assumption about treatment assignment, but there is an empirical version of it often known as “overlap” <span class="citation" data-cites="fogartyDiscreteOptimizationInterpretable2016">(<a href="references.html#ref-fogartyDiscreteOptimizationInterpretable2016" role="doc-biblioref">Fogarty et al. 2016</a>)</span>. Overlap is the extent to which the distributions of covariates in the treated and untreated groups overlap with each other. Even if positivity holds (i.e., all patients in the study population are theoretically eligible for either treatment), it may be that in the sample, there are patient profiles that are absent from one group <span class="citation" data-cites="westreichInvitedCommentaryPositivity2010">(<a href="references.html#ref-westreichInvitedCommentaryPositivity2010" role="doc-biblioref">Westreich and Cole 2010</a>)</span>. In the absence of good overlap, it will be challenging or impossible to use propensity score analysis to make the treatment groups resemble each other on the measured confounders; one is forced either to extrapolate inferences about the groups or to change the target population to one with some overlap (e.g., by targeting the ATO) <span class="citation" data-cites="kingDangersExtremeCounterfactuals2006">(<a href="references.html#ref-kingDangersExtremeCounterfactuals2006" role="doc-biblioref">King and Zeng 2006</a>)</span>.</p>
</section>
<section id="consistency" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="consistency"><span class="header-section-number">1.3.3</span> Consistency</h3>
<p>Consistency is the assumption that there are no unmeasured versions of treatment, i.e., that the treatment values are well-defined <span class="citation" data-cites="hernanDoesObesityShorten2008">(<a href="references.html#ref-hernanDoesObesityShorten2008" role="doc-biblioref">Hernán and Taubman 2008</a>)</span>. Consistency might be violated if there are multiple doses the treatment could take but it is only measured as its presence or absence <span class="citation" data-cites="coleConsistencyStatementCausal2009a">(<a href="references.html#ref-coleConsistencyStatementCausal2009a" role="doc-biblioref">Cole and Frangakis 2009</a>)</span>. A component of consistency is the stable unit treatment value assumption (SUTVA), which requires that the treatment statuses of other patients do not affect the outcomes of a given patient <span class="citation" data-cites="rosenbaumInterferenceUnitsRandomized2007">(<a href="references.html#ref-rosenbaumInterferenceUnitsRandomized2007" role="doc-biblioref">Paul R. Rosenbaum 2007</a>)</span>. This would also constitute a different “version” of treatment; for example, being given a vaccine when no other patients are vaccinated is a different version of the treatment from being given a vaccine when all other patients are vaccinated (assuming the patients can interact with each other) <span class="citation" data-cites="coleConsistencyStatementCausal2009a">(<a href="references.html#ref-coleConsistencyStatementCausal2009a" role="doc-biblioref">Cole and Frangakis 2009</a>)</span>.</p>
<p>When treatment versions are identifiable (e.g., a measured dose), there are extensions for propensity score analysis that can be used for multi-category or continuous treatments <span class="citation" data-cites="imaiCausalInferenceGeneral2004">(<a href="references.html#ref-imaiCausalInferenceGeneral2004" role="doc-biblioref">Imai and Van Dyk 2004</a>)</span>. Methods have also been developed for estimating causal effects in the presence of interference, a SUTVA violation <span class="citation" data-cites="tchetgenCausalInferencePresence2012">(<a href="references.html#ref-tchetgenCausalInferencePresence2012" role="doc-biblioref">Tchetgen and VanderWeele 2012</a>)</span>.</p>
</section>
</section>
<section id="summary" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="summary"><span class="header-section-number">1.4</span> Summary</h2>
<p>Propensity score analysis is not a general-purpose causal inference method; it is a statistical method that can be used to answer a specific type of question, i.e., the total effect of a treatment on an outcome. The research question must be articulated clearly with an estimand specified prior to the analysis. The estimand must consist not only of the components that are common to randomized trials (e.g., the effect measure, the time scale of the outcome, etc.) but also of the components that are more specific to the analysis of observational studies, which include whether the effect is marginal or conditional and to which target population the effect is meant to generalize. Theses choice are described clearly by <span class="citation" data-cites="kahanEliminatingAmbiguousTreatment2023">Kahan et al. (<a href="references.html#ref-kahanEliminatingAmbiguousTreatment2023" role="doc-biblioref">2023</a>)</span> and <span class="citation" data-cites="greiferChoosingEstimandWhen2021">Greifer and Stuart (<a href="references.html#ref-greiferChoosingEstimandWhen2021" role="doc-biblioref">2021</a>)</span>, which are highly recommended.</p>
<p>Propensity score analysis requires certain assumptions for the effect estimate to be validly interpreted as causal, which include satisfaction of the backdoor criterion, positivity, and consistency <span class="citation" data-cites="hernanEstimatingCausalEffects2006">(<a href="references.html#ref-hernanEstimatingCausalEffects2006" role="doc-biblioref">Hernán and Robins 2006</a>)</span>. These assumptions must be assessed by appealing to substantive knowledge about the causal system under study and the variables that are available to the researcher. Satisfaction of the backdoor criterion requires that there is no unmeasured confounding and no variables caused by the treatment or outcome are adjusted for. Positivity requires that all units are eligible to receive either treatment. Consistency requires that there are no unmeasured versions of treatment, including versions defined by the treatment status of other patients in the study. These assumptions and the choices required to satisfy and assess them are described in <span class="citation" data-cites="vanderweelePrinciplesConfounderSelection2019">VanderWeele (<a href="references.html#ref-vanderweelePrinciplesConfounderSelection2019" role="doc-biblioref">2019</a>)</span>, <span class="citation" data-cites="westreichInvitedCommentaryPositivity2010">Westreich and Cole (<a href="references.html#ref-westreichInvitedCommentaryPositivity2010" role="doc-biblioref">2010</a>)</span>, and <span class="citation" data-cites="hernanDoesObesityShorten2008">Hernán and Taubman (<a href="references.html#ref-hernanDoesObesityShorten2008" role="doc-biblioref">2008</a>)</span>, which are highly recommended.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-brookhartConfoundingControlHealthcare2010a" class="csl-entry" role="listitem">
Brookhart, M. Alan, Til Stürmer, Robert J. Glynn, Jeremy Rassen, and Sebastian Schneeweiss. 2010. <span>“Confounding Control in Healthcare Database Research: Challenges and Potential Approaches.”</span> <em>Medical Care</em> 48 (6): S114–20. <a href="https://doi.org/10.1097/MLR.0b013e3181dbebe3">https://doi.org/10.1097/MLR.0b013e3181dbebe3</a>.
</div>
<div id="ref-coleConsistencyStatementCausal2009a" class="csl-entry" role="listitem">
Cole, Stephen R., and Constantine E. Frangakis. 2009. <span>“The Consistency Statement in Causal Inference: A Definition or an Assumption?”</span> <em>Epidemiology</em> 20 (1): 3–5. <a href="https://doi.org/10.1097/EDE.0b013e31818ef366">https://doi.org/10.1097/EDE.0b013e31818ef366</a>.
</div>
<div id="ref-fogartyDiscreteOptimizationInterpretable2016" class="csl-entry" role="listitem">
Fogarty, Colin B., Mark E. Mikkelsen, David F. Gaieski, and Dylan S. Small. 2016. <span>“Discrete Optimization for Interpretable Study Populations and Randomization Inference in an Observational Study of Severe Sepsis Mortality.”</span> <em>Journal of the American Statistical Association</em> 111 (514): 447–58. <a href="https://doi.org/10.1080/01621459.2015.1112802">https://doi.org/10.1080/01621459.2015.1112802</a>.
</div>
<div id="ref-greenlandCausalDiagramsEpidemiologic1999" class="csl-entry" role="listitem">
Greenland, Sander, Judea Pearl, and James M. Robins. 1999. <span>“Causal Diagrams for Epidemiologic Research.”</span> <em>Epidemiology</em> 10 (1): 37–48. <a href="https://www.jstor.org/stable/3702180">https://www.jstor.org/stable/3702180</a>.
</div>
<div id="ref-greiferChoosingEstimandWhen2021" class="csl-entry" role="listitem">
Greifer, Noah, and Elizabeth A. Stuart. 2021. <span>“Choosing the Estimand When Matching or Weighting in Observational Studies.”</span> <em>arXiv:2106.10577 [Stat]</em>, June. <a href="https://arxiv.org/abs/2106.10577">https://arxiv.org/abs/2106.10577</a>.
</div>
<div id="ref-hanDefiningEstimandsClinical2023" class="csl-entry" role="listitem">
Han, Shasha, and Xiao-Hua Zhou. 2023. <span>“Defining Estimands in Clinical Trials: A Unified Procedure.”</span> <em>Statistics in Medicine</em>, March, sim.9702. <a href="https://doi.org/10.1002/sim.9702">https://doi.org/10.1002/sim.9702</a>.
</div>
<div id="ref-hernanEstimatingCausalEffects2006" class="csl-entry" role="listitem">
Hernán, Miguel A, and James M. Robins. 2006. <span>“Estimating Causal Effects from Epidemiological Data.”</span> <em>Journal of Epidemiology and Community Health (1979-)</em> 60 (7): 578–86. <a href="http://www.jstor.org/stable/40795098">http://www.jstor.org/stable/40795098</a>.
</div>
<div id="ref-hernanDoesObesityShorten2008" class="csl-entry" role="listitem">
Hernán, Miguel A, and S L Taubman. 2008. <span>“Does Obesity Shorten Life? The Importance of Well-Defined Interventions to Answer Causal Questions.”</span> <em>International Journal of Obesity</em> 32 (S3): S8–14. <a href="https://doi.org/10.1038/ijo.2008.82">https://doi.org/10.1038/ijo.2008.82</a>.
</div>
<div id="ref-huberCausalPitfallsDecomposition2015" class="csl-entry" role="listitem">
Huber, Martin. 2015. <span>“Causal <span>Pitfalls</span> in the <span>Decomposition</span> of <span>Wage Gaps</span>.”</span> <em>Journal of Business &amp; Economic Statistics</em> 33 (2): 179–91. <a href="https://doi.org/10.1080/07350015.2014.937437">https://doi.org/10.1080/07350015.2014.937437</a>.
</div>
<div id="ref-imaiCausalInferenceGeneral2004" class="csl-entry" role="listitem">
Imai, Kosuke, and David A. Van Dyk. 2004. <span>“Causal Inference with General Treatment Regimes: Generalizing the Propensity Score.”</span> <em>Journal of the American Statistical Association</em> 99 (467): 854–66. <a href="https://www.jstor.org/stable/27590455">https://www.jstor.org/stable/27590455</a>.
</div>
<div id="ref-kahanEliminatingAmbiguousTreatment2023" class="csl-entry" role="listitem">
Kahan, Brennan C, Suzie Cro, Fan Li, and Michael O Harhay. 2023. <span>“Eliminating Ambiguous Treatment Effects Using Estimands.”</span> <em>American Journal of Epidemiology</em>, February, kwad036. <a href="https://doi.org/10.1093/aje/kwad036">https://doi.org/10.1093/aje/kwad036</a>.
</div>
<div id="ref-kingDangersExtremeCounterfactuals2006" class="csl-entry" role="listitem">
King, Gary, and Langche Zeng. 2006. <span>“The Dangers of Extreme Counterfactuals.”</span> <em>Political Analysis</em> 14 (2): 131–59. <a href="https://doi.org/10.1093/pan/mpj004">https://doi.org/10.1093/pan/mpj004</a>.
</div>
<div id="ref-matthayAlternativeCausalInference2020" class="csl-entry" role="listitem">
Matthay, Ellicott C., Erin Hagan, Laura M. Gottlieb, May Lynn Tan, David Vlahov, Nancy E. Adler, and M. Maria Glymour. 2020. <span>“Alternative Causal Inference Methods in Population Health Research: Evaluating Tradeoffs and Triangulating Evidence.”</span> <em>SSM - Population Health</em> 10 (April): 100526. <a href="https://doi.org/10.1016/j.ssmph.2019.100526">https://doi.org/10.1016/j.ssmph.2019.100526</a>.
</div>
<div id="ref-rosenbaumInterferenceUnitsRandomized2007" class="csl-entry" role="listitem">
Rosenbaum, Paul R. 2007. <span>“Interference Between Units in Randomized Experiments.”</span> <em>Journal of the American Statistical Association</em> 102 (477): 191–200. <a href="https://doi.org/10.1198/016214506000001112">https://doi.org/10.1198/016214506000001112</a>.
</div>
<div id="ref-rosenbaumCentralRolePropensity1983" class="csl-entry" role="listitem">
Rosenbaum, Paul R., and Donald B. Rubin. 1983. <span>“The Central Role of the Propensity Score in Observational Studies for Causal Effects.”</span> <em>Biometrika</em> 70 (1): 41–55. <a href="https://doi.org/10.1093/biomet/70.1.41">https://doi.org/10.1093/biomet/70.1.41</a>.
</div>
<div id="ref-tchetgenCausalInferencePresence2012" class="csl-entry" role="listitem">
Tchetgen, Eric J Tchetgen, and Tyler J VanderWeele. 2012. <span>“On Causal Inference in the Presence of Interference.”</span> <em>Statistical Methods in Medical Research</em> 21 (1): 55–75. <a href="https://doi.org/10.1177/0962280210386779">https://doi.org/10.1177/0962280210386779</a>.
</div>
<div id="ref-vanderweelePrinciplesConfounderSelection2019" class="csl-entry" role="listitem">
VanderWeele, Tyler J. 2019. <span>“Principles of Confounder Selection.”</span> <em>European Journal of Epidemiology</em> 34 (3): 211–19. <a href="https://doi.org/10.1007/s10654-019-00494-6">https://doi.org/10.1007/s10654-019-00494-6</a>.
</div>
<div id="ref-westreichInvitedCommentaryPositivity2010" class="csl-entry" role="listitem">
Westreich, Daniel, and Stephen R. Cole. 2010. <span>“Invited Commentary: Positivity in Practice.”</span> <em>American Journal of Epidemiology</em> 171 (6): 674–77. <a href="https://doi.org/10.1093/aje/kwp436">https://doi.org/10.1093/aje/kwp436</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./running.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic Steps</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>