<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Noah Greifer">

<title>Propensity Score Analysis for Medical Research: A Primer and Tutorial - 4&nbsp; Conditioning: matching and weighting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./assessing.html" rel="next">
<link href="./conceptual.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./running.html">Running the Analysis</a></li><li class="breadcrumb-item"><a href="./conditioning.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditioning: matching and weighting</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Propensity Score Analysis for Medical Research: A Primer and Tutorial</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./planning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Planning the Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Running the Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./running.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic Steps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conceptual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Conceptual aspects of the analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conditioning.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditioning: matching and weighting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Assessing quality</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./respecification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Respecification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimating.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimating the treatment effect</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sensitivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Sensitivity analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Advanced topics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Reporting the Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Example</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Example Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ex-match.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Matching</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ex-weight.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Weighting</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-weighting" id="toc-sec-weighting" class="nav-link active" data-scroll-target="#sec-weighting"><span class="header-section-number">4.1</span> Weighting</a></li>
  <li><a href="#sec-matching" id="toc-sec-matching" class="nav-link" data-scroll-target="#sec-matching"><span class="header-section-number">4.2</span> Matching</a>
  <ul class="collapse">
  <li><a href="#stratification" id="toc-stratification" class="nav-link" data-scroll-target="#stratification"><span class="header-section-number">4.2.1</span> Stratification</a></li>
  <li><a href="#subset-selection-and-pair-matching" id="toc-subset-selection-and-pair-matching" class="nav-link" data-scroll-target="#subset-selection-and-pair-matching"><span class="header-section-number">4.2.2</span> Subset selection and pair matching</a></li>
  <li><a href="#full-matching" id="toc-full-matching" class="nav-link" data-scroll-target="#full-matching"><span class="header-section-number">4.2.3</span> Full matching</a></li>
  </ul></li>
  <li><a href="#choosing-a-specification" id="toc-choosing-a-specification" class="nav-link" data-scroll-target="#choosing-a-specification"><span class="header-section-number">4.3</span> Choosing a specification</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-conditioning" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Conditioning: matching and weighting</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In the conditioning step, we perform the matching or weighting on the data, which adjusts the sample in such a way that (ideally) balance is achieved, i.e., the distributions of the covariates are similar between the treated and untreated groups. There are many options one can choose from in the conditioning step, such as which of the propensity score methods is used and how each method is to be customized. Remember that the initial conditioning step does not need to be perfect because it will be respecified in the respecification step (<a href="respecification.html"><span>Chapter&nbsp;6</span></a>). In <a href="assessing.html"><span>Chapter&nbsp;5</span></a>, we discuss how to evaluate the choices made in the conditioning step.</p>
<p>First, we will describe weighting and then matching. The focus here will be on the choices one can make with these methods and how to make them rather than on the technical detail.</p>
<section id="sec-weighting" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-weighting"><span class="header-section-number">4.1</span> Weighting</h2>
<p>Weighting involves estimating a weight for each unit in the sample such that, in the weighted sample, the covariates are balanced. Effect estimation proceeds by computing the weighted outcome means in each treatment group and computing their contrast or fitting a weighted outcome regression model with the treatment as a predictor. Weighting can be used to target any estimand, but the formulas for how the weights are computed depends on the estimand desired. Balancing weights function similarly to sampling weights; while sampling weights shift a sample to be representative of a national population, balancing weights shift each treatment group to resemble each other and a target population.</p>
<p>The most basic form of weighting is propensity score weighting for the ATE, also known as inverse probability of treatment weighting (IPTW). The weights have the following formula:</p>
<p><span class="math display">\[
w_{ATE, i} = \begin{cases}
  1/p_i, &amp; \text{if } A_i = 1, \\
  1/(1-p_i), &amp; \text{if } A_i = 0
\end{cases}
\]</span></p>
<p>where <span class="math inline">\(p_i\)</span> is an individual’s propensity score and <span class="math inline">\(A_i\)</span> is an individual’s treatment value, 1 if treated and 0 if untreated. They are known as “inverse probability” weights because the weights are equal to the inverse of the probability of receiving the treatment actually received. IPTW weights shift the distributions of both the treated and untreated groups to resemble that of the full sample and therefore each other.</p>
<p>Propensity score weighting for the ATT is also known as standardized mortality ratio weighting, and the weights have the following formula:</p>
<p><span class="math display">\[
w_{ATT, i} = p_i \times w_{ATE, i} = \begin{cases}
  1, &amp; \text{if } A_i = 1, \\
  p_i/(1-p_i), &amp; \text{if } A_i = 0
\end{cases}
\]</span></p>
<p>Weights for the ATT shift the distribution of the untreated units to resemble that of the treated units and leave the treated units untouched.</p>
<p>Propensity score weighting for the ATO is also known as overlap weighting, and the weights have the following formula:</p>
<p><span class="math display">\[
w_{ATO, i} = p_i(1-p_i) \times w_{ATE, i} = \begin{cases}
  1-p_i, &amp; \text{if } A_i = 1, \\
  p_i, &amp; \text{if } A_i = 0
\end{cases}
\]</span></p>
<p>Overlap weights upweight units most like those in the other treatment group. Though there are other methods to compute weights that target an overlap sample (e.g., the “matching weights” of <span class="citation" data-cites="liWeightingAnaloguePair2013">L. Li and Greene (<a href="references.html#ref-liWeightingAnaloguePair2013" role="doc-biblioref">2013</a>)</span>), overlap weights tend to outperform them and produce a weighted sample with the most precision of any propensity score weights.</p>
<p>A choice that researchers must make when using propensity score weighting is how to estimate the propensity score. This choice affects the properties of the weights (i.e., the balance they induces and the precision in the weighted sample). The most common method is a logistic regression of the treatment on the covariates. Other popular methods involve machine learning methods like generalized boosted modeling (GBM) <span class="citation" data-cites="mccaffreyPropensityScoreEstimation2004">(<a href="references.html#ref-mccaffreyPropensityScoreEstimation2004" role="doc-biblioref">McCaffrey, Ridgeway, and Morral 2004</a>)</span>, Bayesian additive regression trees (BART) <span class="citation" data-cites="hillChallengesPropensityScore2011">(<a href="references.html#ref-hillChallengesPropensityScore2011" role="doc-biblioref">Hill, Weiss, and Zhai 2011</a>)</span>, and Super Learner <span class="citation" data-cites="alamShouldPropensityScore2019">(<a href="references.html#ref-alamShouldPropensityScore2019" role="doc-biblioref">Alam, Moodie, and Stephens 2019</a>)</span>, though any model that produces predicted class probabilities can be used to estimate propensity scores. Often, versions of these methods incorporate balance optimization into the estimation of the weights; for example, a popular implementation of GBM chooses the value of a tuning parameter as that which minimizes an imbalance statistic <span class="citation" data-cites="mccaffreyPropensityScoreEstimation2004">(<a href="references.html#ref-mccaffreyPropensityScoreEstimation2004" role="doc-biblioref">McCaffrey, Ridgeway, and Morral 2004</a>)</span>. Logistic regression has a particular benefit when using overlap weights: the covariate means will be exactly balanced between the treatment groups.</p>
<p>Many modern methods skip the step of estimating a propensity score and estimate the weights directly. Examples of this approach include entropy balancing <span class="citation" data-cites="hainmuellerEntropyBalancingCausal2012 zhaoEntropyBalancingDoubly2017">(<a href="references.html#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>; <a href="references.html#ref-zhaoEntropyBalancingDoubly2017" role="doc-biblioref">Zhao and Percival 2017</a>)</span>, stable balancing weights <span class="citation" data-cites="zubizarretaStableWeightsThat2015">(<a href="references.html#ref-zubizarretaStableWeightsThat2015" role="doc-biblioref">Zubizarreta 2015</a>)</span>, and energy balancing <span class="citation" data-cites="hulingEnergyBalancingCovariate2022">(<a href="references.html#ref-hulingEnergyBalancingCovariate2022" role="doc-biblioref">Huling and Mak, n.d.</a>)</span>. This distinction is explored in detail by <span class="citation" data-cites="chattopadhyayBalancingVsModeling2020">Chattopadhyay, Hase, and Zubizarreta (<a href="references.html#ref-chattopadhyayBalancingVsModeling2020" role="doc-biblioref">2020</a>)</span>. A popular weighting method, covariate balancing propensity score (CBPS) weighting, combines optimization and logistic regression-based propensity score estimation <span class="citation" data-cites="imaiCovariateBalancingPropensity2014">(<a href="references.html#ref-imaiCovariateBalancingPropensity2014" role="doc-biblioref">Imai and Ratkovic 2014</a>)</span> (though this does not necessarily confer any benefits over methods that don’t estimate a propensity score <span class="citation" data-cites="liPropensityScoreAnalysis2021a">(<a href="references.html#ref-liPropensityScoreAnalysis2021a" role="doc-biblioref">Y. Li and Li 2021</a>)</span>). These optimization-based methods often exactly or approximately balance features of the distribution of covariates while retaining precision in the weighted sample, making them highly effective<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Weighting methods sometimes yield “extreme” weights, i.e., a few weights that take on a much larger value than the others and dominate the analysis, which can make balance worse and reduce precision. This can occur especially when propensity score weighting for the ATE, as small propensity scores in the treated group and large propensity scores in the untreated group cause weights to be large when inverted. One approach to dealing with extreme weights is to trim the weights, which can involve either removing units with large weights or extreme propensity scores or setting the value of their weights to a smaller value (winsorizing). These methods often change the estimand from the ATE, in which case the ATO should be targeting using overlap weights instead.</p>
</section>
<section id="sec-matching" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-matching"><span class="header-section-number">4.2</span> Matching</h2>
<p>Matching involves dropping or reorganizing units into strata such that the remaining sample is balanced <span class="citation" data-cites="greiferMatchingMethodsConfounder2021a">(<a href="references.html#ref-greiferMatchingMethodsConfounder2021a" role="doc-biblioref">Greifer and Stuart 2021a</a>)</span>. Examples include pair matching, pure subset selection (in which units are dropped from the sample but no pairing occurs), and subclassification, among others. The outputs of a matching method are a set of matching weights and, if pairing or stratification is done, pair or stratum membership for each unit. Matching weights function identically to propensity score weights as described above; indeed, matching can be seen as a restricted form of weighting, where that restriction can sometimes afford benefits in terms of robustness and precision. <span class="citation" data-cites="stuartMatchingMethodsCausal2010">Stuart (<a href="references.html#ref-stuartMatchingMethodsCausal2010" role="doc-biblioref">2010</a>)</span> provides an excellent introduction to matching.</p>
<p>Below, we briefly describe the two major forms of matching, stratification and subset selection (including pair matching).</p>
<section id="stratification" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="stratification"><span class="header-section-number">4.2.1</span> Stratification</h3>
<p>Stratification simply involves assigning units into strata such that, within strata, the covariates are balanced between treatment groups. The most straightforward method of stratification is exact matching, in which sets of units with identical covariate values are placed into strata based on those values. Any units with no exact matches in the other treatment group are dropped. The remaining sample will be exactly balanced on all included covariates. In practice, continuous variables or categorical variables with many categories make exact matching impossible. One alternative is coarsened exact matching (CEM) <span class="citation" data-cites="iacusCausalInferenceBalance2012 iacusMultivariateMatchingMethods2011">(<a href="references.html#ref-iacusCausalInferenceBalance2012" role="doc-biblioref">Iacus, King, and Porro 2012</a>, <a href="references.html#ref-iacusMultivariateMatchingMethods2011" role="doc-biblioref">2011</a>)</span>, which is simply exact matching on coarsened version of the covariates. The degree of coarsening is controlled by the researcher to strike a balance between discarding units with no matches and ensuring the units within strata are relatively homogeneous in the covariates.</p>
<p>Another alternative is propensity score subclassification <span class="citation" data-cites="rosenbaumReducingBiasObservational1984">(<a href="references.html#ref-rosenbaumReducingBiasObservational1984" role="doc-biblioref">Rosenbaum and Rubin 1984</a>)</span>, in which units are placed into strata based on their propensity score values. The number of strata is decided by the researcher; although early literature recommends as few as 5 subclasses, it is always best to try larger numbers of subclass to find the one that yields the highest quality matches, which can sometimes be in the hundreds depending on the sample size <span class="citation" data-cites="desaiPropensityscorebasedFineStratification2017">(<a href="references.html#ref-desaiPropensityscorebasedFineStratification2017" role="doc-biblioref">Desai et al. 2017</a>)</span>.</p>
<p>The result of stratification is a set of stratification weights. These are computed as follows: 1) compute the proportion of units in each stratum that are treated, 2) for each unit, assign to it this proportion in its stratum as a new stratum “propensity score”, and 3) apply the propensity score weighting formulas above to the new stratum propensity score using the formula that corresponds to the desired estimand. In this way, stratification is a form of propensity score weighting in which the weights are estimated using a multi-step procedure rather than directly from the propensity scores. This method is known as marginal mean weighting through stratification (MMWS) <span class="citation" data-cites="hongMarginalMeanWeighting2010">(<a href="references.html#ref-hongMarginalMeanWeighting2010" role="doc-biblioref">Hong 2010</a>)</span> or fine stratification <span class="citation" data-cites="desaiPropensityscorebasedFineStratification2017">(<a href="references.html#ref-desaiPropensityscorebasedFineStratification2017" role="doc-biblioref">Desai et al. 2017</a>)</span>. <a href="https://ngreifer.github.io/blog/matching-weights/">This blog post</a> explains this idea in more detail.</p>
</section>
<section id="subset-selection-and-pair-matching" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="subset-selection-and-pair-matching"><span class="header-section-number">4.2.2</span> Subset selection and pair matching</h3>
<p>Subset selection involves taking a subset of units from the original sample and dropping the rest, ideally in such a way that the remaining sample is balanced on the covariates. The most common method of subset selection is pair matching, in which treated units are paired with untreated units, and any unpaired units are dropped. There are a number of ways to customize pair matching to improve the balance and precision of the resulting sample:</p>
<ul>
<li><p><strong>The distance measure use to compute the closeness between units</strong>. The most common measure is the propensity score difference between each treated and untreated unit. Other distances include the Mahalanobis distance and its robust variant and the scaled Euclidean distance, which are computed from the covariates directly and do not require a propensity score, though a propensity score can be added as an additional covariate in computing them. A powerful optimization-based matching method called genetic matching adjusts elements of the distance measure used in order to optimize the balance of the resulting sample <span class="citation" data-cites="diamondGeneticMatchingEstimating2013">(<a href="references.html#ref-diamondGeneticMatchingEstimating2013" role="doc-biblioref">Diamond and Sekhon 2013</a>)</span>. The best distance measure to use will depend on the unique features of the dataset <span class="citation" data-cites="ripolloneImplicationsPropensityScore2018">(<a href="references.html#ref-ripolloneImplicationsPropensityScore2018" role="doc-biblioref">Ripollone et al. 2018</a>)</span>, so several should be tried, though genetic matching automates this process.</p></li>
<li><p><strong>The number of matches unit receives.</strong> Each treated unit can receive one or more control units as a match, and this number can be chosen by the researcher. For example, one can request 2:1 matching instead of 1:1 matching, which increases the size of the resulting sample but may worsen balance because worse matches are being included. The number of matches each unit receives can be fixed across all units or varied <span class="citation" data-cites="mingSubstantialGainsBias2000">(<a href="references.html#ref-mingSubstantialGainsBias2000" role="doc-biblioref">Ming and Rosenbaum 2000</a>)</span>.</p></li>
<li><p><strong>Whether matching is done with or without replacement.</strong> One can choose whether untreated units can be reused as matches for multiple treated units. Matching with replacement often yields better balance and eliminates the effect of who gets matched first on the resulting sample. Matching with replacement can yield imprecision in the effect estimate when the same untreated unit is matched many times; the number of times each untreated unit can be matched can be limited by the researcher. Inference after matching with replacement can be more challenging than when matching without replacement<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p></li>
<li><p><strong>The order of matches.</strong> When matching without replacement, the order that treated units are matched matters. There are a variety of ways one can specify this order with varying evidence supporting each choice <span class="citation" data-cites="rubinMatchingRemoveBias1973 austinComparison12Algorithms2014">(<a href="references.html#ref-rubinMatchingRemoveBias1973" role="doc-biblioref">Rubin 1973</a>; <a href="references.html#ref-austinComparison12Algorithms2014" role="doc-biblioref">Austin 2014</a>)</span>, so it is best to try various orders. An alternative is to use optimal pair matching <span class="citation" data-cites="hansenOptimalFullMatching2006 guComparisonMultivariateMatching1993">(<a href="references.html#ref-hansenOptimalFullMatching2006" role="doc-biblioref">Hansen and Klopfer 2006</a>; <a href="references.html#ref-guComparisonMultivariateMatching1993" role="doc-biblioref">Gu and Rosenbaum 1993</a>)</span>, which optimizes a global distance criterion.</p></li>
<li><p><strong>Calipers and exact matching constraints.</strong> A caliper is a limit on how far two units can be before they are disallowed from being matched. Using calipers can improve balance but decrease precision because additional units are discarded (i.e., those without any matches within the caliper) <span class="citation" data-cites="austinComparison12Algorithms2014">(<a href="references.html#ref-austinComparison12Algorithms2014" role="doc-biblioref">Austin 2014</a>)</span>. It is very common to place a caliper on the propensity score, though it is also possible to place calipers on covariates directly. Though there has been some research into optimal caliper widths <span class="citation" data-cites="austinOptimalCaliperWidths2011">(<a href="references.html#ref-austinOptimalCaliperWidths2011" role="doc-biblioref">Austin 2011</a>)</span>, the best caliper will depend on the unique features of the dataset, and so many should be tried and evaluated. An exact matching constraint requires that two unit have identical values of the given covariate in order to be allowed to be matched. When calipers or exact matching constraints are used, balance often improves (sometimes dramatically), but discarding treated units changes the estimand to the ATO, which may not be desired <span class="citation" data-cites="greiferChoosingEstimandWhen2021 rosenbaumBiasDueIncomplete1985">(<a href="references.html#ref-greiferChoosingEstimandWhen2021" role="doc-biblioref">Greifer and Stuart 2021b</a>; <a href="references.html#ref-rosenbaumBiasDueIncomplete1985" role="doc-biblioref">Rosenbaum and Rubin 1985</a>)</span>. Applying calipers can also make balance worse if good balance has already been achieved without them <span class="citation" data-cites="kingWhyPropensityScores2019">(<a href="references.html#ref-kingWhyPropensityScores2019" role="doc-biblioref">King and Nielsen 2019</a>)</span>.</p></li>
</ul>
<p>There are also methods of subset selection without pairing, such as cardinality and profile matching <span class="citation" data-cites="zubizarretaMatchingBalancePairing2014 cohnProfileMatchingGeneralization2022">(<a href="references.html#ref-zubizarretaMatchingBalancePairing2014" role="doc-biblioref">Zubizarreta, Paredes, and Rosenbaum 2014</a>; <a href="references.html#ref-cohnProfileMatchingGeneralization2022" role="doc-biblioref">Cohn and Zubizarreta 2022</a>)</span>. These use optimization to find the largest matched sample that satisfies balance constraints set by the user and are starting to see broader use in medical research <span class="citation" data-cites="niknamUsingCardinalityMatching2022 fortinIndirectCovariateBalance2022">(e.g., <a href="references.html#ref-niknamUsingCardinalityMatching2022" role="doc-biblioref">Niknam and Zubizarreta 2022</a>; <a href="references.html#ref-fortinIndirectCovariateBalance2022" role="doc-biblioref">Fortin and Schuemie 2022</a>)</span>.</p>
</section>
<section id="full-matching" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="full-matching"><span class="header-section-number">4.2.3</span> Full matching</h3>
<p>Full matching is an effective matching method that is somewhat of a cross between pair matching and stratification <span class="citation" data-cites="stuartUsingFullMatching2008 hansenOptimalFullMatching2006">(<a href="references.html#ref-stuartUsingFullMatching2008" role="doc-biblioref">Stuart and Green 2008</a>; <a href="references.html#ref-hansenOptimalFullMatching2006" role="doc-biblioref">Hansen and Klopfer 2006</a>)</span>. Every unit in the sample is assigned to a stratum as with stratification methods, but the strata are formed based on the pairwise distances between units. Full matching tends to outperform other matching methods and can be customized in many of the same ways <span class="citation" data-cites="austinOptimalFullMatching2015 austinEstimatingEffectTreatment2017">(<a href="references.html#ref-austinOptimalFullMatching2015" role="doc-biblioref">Austin and Stuart 2015</a>, <a href="references.html#ref-austinEstimatingEffectTreatment2017" role="doc-biblioref">2017b</a>)</span>. Variations of full matching often run much faster than other matching algorithms <span class="citation" data-cites="savjeGeneralizedFullMatching2021">(<a href="references.html#ref-savjeGeneralizedFullMatching2021" role="doc-biblioref">Sävje, Higgins, and Sekhon 2021</a>)</span>. Unlike other pair matching methods, full matching can be used to estimate the ATT, ATC, or ATE. Full matching can also been seen as a alternative to IPTW that can be more robust to misspecification <span class="citation" data-cites="austinPerformanceInverseProbability2017">(<a href="references.html#ref-austinPerformanceInverseProbability2017" role="doc-biblioref">Austin and Stuart 2017a</a>)</span>.</p>
</section>
</section>
<section id="choosing-a-specification" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="choosing-a-specification"><span class="header-section-number">4.3</span> Choosing a specification</h2>
<p>We explain how to choose among the variety of weighting and matching methods in <a href="assessing.html"><span>Chapter&nbsp;5</span></a>. In short, the choice should depend on covariate balance, precision, and respect of the desired estimand. One does not need to choose a method and commit to it; one can instead try many, assess their quality, and move forward with effect estimation using only the best among those compared. However, this search can be shortened by using methods known to perform exceptionally well or that can be specified to respond to a researcher’s precise requirements.</p>
<p>Some methods are more popular in certain fields; for example, medical research often uses matching, whereas epidemiological research often uses weighting. In some cases, the popularity of methods in certain fields reflects real substantive demands, but in many cases it simply reflects trends and cultures or the specific methods emphasized in training materials for students. For example, epidemiological training emphasizes the use of weighting over matching <span class="citation" data-cites="hernanCausalInferenceWhat2020">(<a href="references.html#ref-hernanCausalInferenceWhat2020" role="doc-biblioref">Hernán and Robins 2020</a>)</span>, even though they often serve the same purpose and perform equally well <span class="citation" data-cites="greiferMatchingMethodsConfounder2021a kushCovariateBalanceObservational2022">(<a href="references.html#ref-greiferMatchingMethodsConfounder2021a" role="doc-biblioref">Greifer and Stuart 2021a</a>; <a href="references.html#ref-kushCovariateBalanceObservational2022" role="doc-biblioref">Kush et al. 2022</a>)</span>.</p>
<p>One key aspect to remember is that the basic or default method is almost never the best method and should not be used just because it is the most familiar or popular in a field. For example, 1:1 pair matching on the propensity score is a popular matching method in medical research, even though it is uniformly outperformed by genetic matching <span class="citation" data-cites="diamondGeneticMatchingEstimating2013">(<a href="references.html#ref-diamondGeneticMatchingEstimating2013" role="doc-biblioref">Diamond and Sekhon 2013</a>)</span> and very often performs worse than methods that are no more difficult to use, such as full matching <span class="citation" data-cites="austinOptimalFullMatching2015">(<a href="references.html#ref-austinOptimalFullMatching2015" role="doc-biblioref">Austin and Stuart 2015</a>)</span> and cardinality matching <span class="citation" data-cites="viscontiHandlingLimitedOverlap2018a">(<a href="references.html#ref-viscontiHandlingLimitedOverlap2018a" role="doc-biblioref">Visconti and Zubizarreta 2018</a>)</span>. Similarly, propensity score weighting often performs worse than modern optimization-based methods like entropy balancing <span class="citation" data-cites="hainmuellerEntropyBalancingCausal2012">(<a href="references.html#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-abadieLargeSampleProperties2006" class="csl-entry" role="listitem">
Abadie, Alberto, and Guido W. Imbens. 2006. <span>“Large Sample Properties of Matching Estimators for Average Treatment Effects.”</span> <em>Econometrica</em> 74 (1): 235–67. <a href="https://doi.org/10.1111/j.1468-0262.2006.00655.x">https://doi.org/10.1111/j.1468-0262.2006.00655.x</a>.
</div>
<div id="ref-abadieMatchingEstimatedPropensity2016" class="csl-entry" role="listitem">
———. 2016. <span>“Matching on the Estimated Propensity Score.”</span> <em>Econometrica</em> 84 (2): 781–807. <a href="https://doi.org/10.3982/ECTA11293">https://doi.org/10.3982/ECTA11293</a>.
</div>
<div id="ref-alamShouldPropensityScore2019" class="csl-entry" role="listitem">
Alam, Shomoita, Erica E. M. Moodie, and David A. Stephens. 2019. <span>“Should a Propensity Score Model Be Super? The Utility of Ensemble Procedures for Causal Adjustment.”</span> <em>Statistics in Medicine</em> 38 (9): 1690–1702. <a href="https://doi.org/10.1002/sim.8075">https://doi.org/10.1002/sim.8075</a>.
</div>
<div id="ref-austinOptimalCaliperWidths2011" class="csl-entry" role="listitem">
Austin, Peter C. 2011. <span>“Optimal Caliper Widths for Propensity-Score Matching When Estimating Differences in Means and Differences in Proportions in Observational Studies.”</span> <em>Pharmaceutical Statistics</em> 10 (2): 150–61. <a href="https://doi.org/10.1002/pst.433">https://doi.org/10.1002/pst.433</a>.
</div>
<div id="ref-austinComparison12Algorithms2014" class="csl-entry" role="listitem">
———. 2014. <span>“A Comparison of 12 Algorithms for Matching on the Propensity Score.”</span> <em>Statistics in Medicine</em> 33 (6): 1057–69. <a href="https://doi.org/10.1002/sim.6004">https://doi.org/10.1002/sim.6004</a>.
</div>
<div id="ref-austinOptimalFullMatching2015" class="csl-entry" role="listitem">
Austin, Peter C., and Elizabeth A. Stuart. 2015. <span>“Optimal Full Matching for Survival Outcomes: A Method That Merits More Widespread Use.”</span> <em>Statistics in Medicine</em> 34 (30): 3949–67. <a href="https://doi.org/10.1002/sim.6602">https://doi.org/10.1002/sim.6602</a>.
</div>
<div id="ref-austinPerformanceInverseProbability2017" class="csl-entry" role="listitem">
———. 2017a. <span>“The Performance of Inverse Probability of Treatment Weighting and Full Matching on the Propensity Score in the Presence of Model Misspecification When Estimating the Effect of Treatment on Survival Outcomes.”</span> <em>Statistical Methods in Medical Research</em> 26 (4): 1654–70. <a href="https://doi.org/10.1177/0962280215584401">https://doi.org/10.1177/0962280215584401</a>.
</div>
<div id="ref-austinEstimatingEffectTreatment2017" class="csl-entry" role="listitem">
———. 2017b. <span>“Estimating the Effect of Treatment on Binary Outcomes Using Full Matching on the Propensity Score.”</span> <em>Statistical Methods in Medical Research</em> 26 (6): 2505–25. <a href="https://doi.org/10.1177/0962280215601134">https://doi.org/10.1177/0962280215601134</a>.
</div>
<div id="ref-chattopadhyayBalancingVsModeling2020" class="csl-entry" role="listitem">
Chattopadhyay, Ambarish, Christopher H. Hase, and José R. Zubizarreta. 2020. <span>“Balancing Vs Modeling Approaches to Weighting in Practice.”</span> <em>Statistics in Medicine</em> 39 (24): 3227–54. <a href="https://doi.org/10.1002/sim.8659">https://doi.org/10.1002/sim.8659</a>.
</div>
<div id="ref-cohnProfileMatchingGeneralization2022" class="csl-entry" role="listitem">
Cohn, Eric R., and José R. Zubizarreta. 2022. <span>“Profile Matching for the Generalization and Personalization of Causal Inferences.”</span> <em>Epidemiology</em> 33 (5): 678. <a href="https://doi.org/10.1097/EDE.0000000000001517">https://doi.org/10.1097/EDE.0000000000001517</a>.
</div>
<div id="ref-desaiPropensityscorebasedFineStratification2017" class="csl-entry" role="listitem">
Desai, Rishi J., Kenneth J. Rothman, Brian .T Bateman, Sonia Hernandez-Diaz, and Krista F. Huybrechts. 2017. <span>“A Propensity-Score-Based Fine Stratification Approach for Confounding Adjustment When Exposure Is Infrequent:”</span> <em>Epidemiology</em> 28 (2): 249–57. <a href="https://doi.org/10.1097/EDE.0000000000000595">https://doi.org/10.1097/EDE.0000000000000595</a>.
</div>
<div id="ref-diamondGeneticMatchingEstimating2013" class="csl-entry" role="listitem">
Diamond, Alexis, and Jasjeet S. Sekhon. 2013. <span>“Genetic Matching for Estimating Causal Effects: A General Multivariate Matching Method for Achieving Balance in Observational Studies.”</span> <em>Review of Economics and Statistics</em> 95 (3): 932945. <a href="https://doi.org/10.1162/REST_a_00318">https://doi.org/10.1162/REST_a_00318</a>.
</div>
<div id="ref-fortinIndirectCovariateBalance2022" class="csl-entry" role="listitem">
Fortin, Stephen P., and Martijn Schuemie. 2022. <span>“Indirect Covariate Balance and Residual Confounding: <span>An</span> Applied Comparison of Propensity Score Matching and Cardinality Matching.”</span> <em>Pharmacoepidemiology and Drug Safety</em> 31 (12): 1242–52. <a href="https://doi.org/10.1002/pds.5510">https://doi.org/10.1002/pds.5510</a>.
</div>
<div id="ref-greiferMatchingMethodsConfounder2021a" class="csl-entry" role="listitem">
Greifer, Noah, and Elizabeth A Stuart. 2021a. <span>“Matching Methods for Confounder Adjustment: An Addition to the Epidemiologist<span>’</span>s Toolbox.”</span> <em>Epidemiologic Reviews</em>, June, mxab003. <a href="https://doi.org/10.1093/epirev/mxab003">https://doi.org/10.1093/epirev/mxab003</a>.
</div>
<div id="ref-greiferChoosingEstimandWhen2021" class="csl-entry" role="listitem">
Greifer, Noah, and Elizabeth A. Stuart. 2021b. <span>“Choosing the Estimand When Matching or Weighting in Observational Studies.”</span> <em>arXiv:2106.10577 [Stat]</em>, June. <a href="https://arxiv.org/abs/2106.10577">https://arxiv.org/abs/2106.10577</a>.
</div>
<div id="ref-guComparisonMultivariateMatching1993" class="csl-entry" role="listitem">
Gu, Xing Sam, and Paul R. Rosenbaum. 1993. <span>“Comparison of Multivariate Matching Methods: Structures, Distances, and Algorithms.”</span> <em>Journal of Computational and Graphical Statistics</em> 2 (4): 405. <a href="https://doi.org/10.2307/1390693">https://doi.org/10.2307/1390693</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry" role="listitem">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies.”</span> <em>Political Analysis</em> 20 (1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-hansenOptimalFullMatching2006" class="csl-entry" role="listitem">
Hansen, Ben B, and Stephanie Olsen Klopfer. 2006. <span>“Optimal Full Matching and Related Designs via Network Flows.”</span> <em>Journal of Computational and Graphical Statistics</em> 15 (3): 609–27. <a href="https://doi.org/10.1198/106186006X137047">https://doi.org/10.1198/106186006X137047</a>.
</div>
<div id="ref-hernanCausalInferenceWhat2020" class="csl-entry" role="listitem">
Hernán, Miguel A, and James M Robins. 2020. <em>Causal Inference: What If</em>. Boca Raton: Chapman &amp; Hall/CRC. <a href="https://cdn1.sph.harvard.edu/wp-content/uploads/sites/1268/2020/01/ci_hernanrobins_21jan20.pdf">https://cdn1.sph.harvard.edu/wp-content/uploads/sites/1268/2020/01/ci_hernanrobins_21jan20.pdf</a>.
</div>
<div id="ref-hillIntervalEstimationTreatment2006" class="csl-entry" role="listitem">
Hill, Jennifer, and Jerome P. Reiter. 2006. <span>“Interval Estimation for Treatment Effects Using Propensity Score Matching.”</span> <em>Statistics in Medicine</em> 25 (13): 2230–56. <a href="https://doi.org/10.1002/sim.2277">https://doi.org/10.1002/sim.2277</a>.
</div>
<div id="ref-hillChallengesPropensityScore2011" class="csl-entry" role="listitem">
Hill, Jennifer, Christopher Weiss, and Fuhua Zhai. 2011. <span>“Challenges With Propensity Score Strategies in a High-Dimensional Setting and a Potential Alternative.”</span> <em>Multivariate Behavioral Research</em> 46 (3): 477–513. <a href="https://doi.org/10.1080/00273171.2011.570161">https://doi.org/10.1080/00273171.2011.570161</a>.
</div>
<div id="ref-hongMarginalMeanWeighting2010" class="csl-entry" role="listitem">
Hong, Guanglei. 2010. <span>“Marginal Mean Weighting Through Stratification: Adjustment for Selection Bias in Multilevel Data.”</span> <em>Journal of Educational and Behavioral Statistics</em> 35 (5): 499–531. <a href="https://doi.org/10.3102/1076998609359785">https://doi.org/10.3102/1076998609359785</a>.
</div>
<div id="ref-hulingEnergyBalancingCovariate2022" class="csl-entry" role="listitem">
Huling, Jared D., and Simon Mak. n.d. <span>“Energy Balancing of Covariate Distributions.”</span> <a href="https://doi.org/10.48550/arXiv.2004.13962">https://doi.org/10.48550/arXiv.2004.13962</a>.
</div>
<div id="ref-iacusMultivariateMatchingMethods2011" class="csl-entry" role="listitem">
Iacus, Stefano M., Gary King, and Giuseppe Porro. 2011. <span>“Multivariate Matching Methods That Are Monotonic Imbalance Bounding.”</span> <em>Journal of the American Statistical Association</em> 106 (493): 345–61. <a href="https://doi.org/10.1198/jasa.2011.tm09599">https://doi.org/10.1198/jasa.2011.tm09599</a>.
</div>
<div id="ref-iacusCausalInferenceBalance2012" class="csl-entry" role="listitem">
———. 2012. <span>“Causal Inference Without Balance Checking: Coarsened Exact Matching.”</span> <em>Political Analysis</em> 20 (1): 1–24. <a href="https://doi.org/10.1093/pan/mpr013">https://doi.org/10.1093/pan/mpr013</a>.
</div>
<div id="ref-imaiCovariateBalancingPropensity2014" class="csl-entry" role="listitem">
Imai, Kosuke, and Marc Ratkovic. 2014. <span>“Covariate Balancing Propensity Score.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 76 (1): 243263. <a href="https://doi.org/10.1111/rssb.12027">https://doi.org/10.1111/rssb.12027</a>.
</div>
<div id="ref-kingWhyPropensityScores2019" class="csl-entry" role="listitem">
King, Gary, and Richard Nielsen. 2019. <span>“Why Propensity Scores Should Not Be Used for Matching.”</span> <em>Political Analysis</em>, May, 1–20. <a href="https://doi.org/10.1017/pan.2019.11">https://doi.org/10.1017/pan.2019.11</a>.
</div>
<div id="ref-kushCovariateBalanceObservational2022" class="csl-entry" role="listitem">
Kush, Joseph M., Elise T. Pas, Rashelle J. Musci, and Catherine P. Bradshaw. 2022. <span>“Covariate Balance for Observational Effectiveness Studies: A Comparison of Matching and Weighting.”</span> <em>Journal of Research on Educational Effectiveness</em> 0 (0): 1–24. <a href="https://doi.org/10.1080/19345747.2022.2110545">https://doi.org/10.1080/19345747.2022.2110545</a>.
</div>
<div id="ref-liWeightingAnaloguePair2013" class="csl-entry" role="listitem">
Li, Liang, and Tom Greene. 2013. <span>“A Weighting Analogue to Pair Matching in Propensity Score Analysis.”</span> <em>The International Journal of Biostatistics</em> 9 (2). <a href="https://doi.org/10.1515/ijb-2012-0030">https://doi.org/10.1515/ijb-2012-0030</a>.
</div>
<div id="ref-liPropensityScoreAnalysis2021a" class="csl-entry" role="listitem">
Li, Yan, and Liang Li. 2021. <span>“Propensity Score Analysis Methods with Balancing Constraints: A Monte Carlo Study.”</span> <em>Statistical Methods in Medical Research</em> 30 (4): 1119–42. <a href="https://doi.org/10.1177/0962280220983512">https://doi.org/10.1177/0962280220983512</a>.
</div>
<div id="ref-mccaffreyPropensityScoreEstimation2004" class="csl-entry" role="listitem">
McCaffrey, Daniel F., Greg Ridgeway, and Andrew R. Morral. 2004. <span>“Propensity Score Estimation With Boosted Regression for Evaluating Causal Effects in Observational Studies.”</span> <em>Psychological Methods</em> 9 (4): 403–25. <a href="https://doi.org/10.1037/1082-989X.9.4.403">https://doi.org/10.1037/1082-989X.9.4.403</a>.
</div>
<div id="ref-mingSubstantialGainsBias2000" class="csl-entry" role="listitem">
Ming, Kewei, and Paul R. Rosenbaum. 2000. <span>“Substantial Gains in Bias Reduction from Matching with a Variable Number of Controls.”</span> <em>Biometrics</em> 56 (1): 118–24. <a href="https://doi.org/10.1111/j.0006-341X.2000.00118.x">https://doi.org/10.1111/j.0006-341X.2000.00118.x</a>.
</div>
<div id="ref-niknamUsingCardinalityMatching2022" class="csl-entry" role="listitem">
Niknam, Bijan A., and Jose R. Zubizarreta. 2022. <span>“Using <span>Cardinality Matching</span> to <span>Design Balanced</span> and <span>Representative Samples</span> for <span>Observational Studies</span>.”</span> <em>JAMA</em> 327 (2): 173–74. <a href="https://doi.org/10.1001/jama.2021.20555">https://doi.org/10.1001/jama.2021.20555</a>.
</div>
<div id="ref-ripolloneImplicationsPropensityScore2018" class="csl-entry" role="listitem">
Ripollone, John E., Krista F. Huybrechts, Kenneth J. Rothman, Ryan E. Ferguson, and Jessica M. Franklin. 2018. <span>“Implications of the Propensity Score Matching Paradox in Pharmacoepidemiology.”</span> <em>American Journal of Epidemiology</em> 187 (9): 1951–61. <a href="https://doi.org/10.1093/aje/kwy078">https://doi.org/10.1093/aje/kwy078</a>.
</div>
<div id="ref-rosenbaumReducingBiasObservational1984" class="csl-entry" role="listitem">
Rosenbaum, Paul R., and Donald B. Rubin. 1984. <span>“Reducing Bias in Observational Studies Using Subclassification on the Propensity Score.”</span> <em>Journal of the American Statistical Association</em> 79 (387): 516–24. <a href="https://doi.org/10.2307/2288398">https://doi.org/10.2307/2288398</a>.
</div>
<div id="ref-rosenbaumBiasDueIncomplete1985" class="csl-entry" role="listitem">
———. 1985. <span>“The Bias Due to Incomplete Matching.”</span> <em>Biometrics</em> 41 (1): 103–16. <a href="https://doi.org/10.2307/2530647">https://doi.org/10.2307/2530647</a>.
</div>
<div id="ref-rubinMatchingRemoveBias1973" class="csl-entry" role="listitem">
Rubin, Donald B. 1973. <span>“Matching to Remove Bias in Observational Studies.”</span> <em>Biometrics</em> 29 (1): 159–83. <a href="https://doi.org/10.2307/2529684">https://doi.org/10.2307/2529684</a>.
</div>
<div id="ref-savjeGeneralizedFullMatching2021" class="csl-entry" role="listitem">
Sävje, Fredrik, Michael J. Higgins, and Jasjeet S. Sekhon. 2021. <span>“Generalized Full Matching.”</span> <em>Political Analysis</em> 29 (4): 423–47. <a href="https://doi.org/10.1017/pan.2020.32">https://doi.org/10.1017/pan.2020.32</a>.
</div>
<div id="ref-stuartMatchingMethodsCausal2010" class="csl-entry" role="listitem">
Stuart, Elizabeth A. 2010. <span>“Matching Methods for Causal Inference: A Review and a Look Forward.”</span> <em>Statistical Science</em> 25 (1): 1–21. <a href="https://doi.org/10.1214/09-STS313">https://doi.org/10.1214/09-STS313</a>.
</div>
<div id="ref-stuartUsingFullMatching2008" class="csl-entry" role="listitem">
Stuart, Elizabeth A., and Kerry M. Green. 2008. <span>“Using Full Matching to Estimate Causal Effects in Nonexperimental Studies: Examining the Relationship Between Adolescent Marijuana Use and Adult Outcomes.”</span> <em>Developmental Psychology</em>, New methods for new questions in developmental psychology, 44 (2): 395–406. <a href="https://doi.org/10.1037/0012-1649.44.2.395">https://doi.org/10.1037/0012-1649.44.2.395</a>.
</div>
<div id="ref-viscontiHandlingLimitedOverlap2018a" class="csl-entry" role="listitem">
Visconti, Giancarlo, and José R. Zubizarreta. 2018. <span>“Handling Limited Overlap in Observational Studies with Cardinality Matching.”</span> <em>Observational Studies</em> 4 (1): 217–49. <a href="https://doi.org/10.1353/obs.2018.0012">https://doi.org/10.1353/obs.2018.0012</a>.
</div>
<div id="ref-zhaoEntropyBalancingDoubly2017" class="csl-entry" role="listitem">
Zhao, Qingyuan, and Daniel Percival. 2017. <span>“Entropy Balancing Is Doubly Robust.”</span> <em>Journal of Causal Inference</em> 5 (1). <a href="https://doi.org/10.1515/jci-2016-0010">https://doi.org/10.1515/jci-2016-0010</a>.
</div>
<div id="ref-zubizarretaStableWeightsThat2015" class="csl-entry" role="listitem">
Zubizarreta, José R. 2015. <span>“Stable Weights That Balance Covariates for Estimation with Incomplete Outcome Data.”</span> <em>Journal of the American Statistical Association</em> 110 (511): 910–22. <a href="https://doi.org/10.1080/01621459.2015.1023805">https://doi.org/10.1080/01621459.2015.1023805</a>.
</div>
<div id="ref-zubizarretaMatchingBalancePairing2014" class="csl-entry" role="listitem">
Zubizarreta, José R., Ricardo D. Paredes, and Paul R. Rosenbaum. 2014. <span>“Matching for Balance, Pairing for Heterogeneity in an Observational Study of the Effectiveness of for-Profit and Not-for-Profit High Schools in <span>Chile</span>.”</span> <em>The Annals of Applied Statistics</em> 8 (1): 204–31. <a href="https://doi.org/10.1214/13-AOAS713">https://doi.org/10.1214/13-AOAS713</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>A common theme in many areas of statistics is that newer methods perform better than older methods in general. However, those newer methods are often less well studied and opaque or unheard of by applied researchers. Their absence from the applied literature and the popularity of older, more basic methods is not an indication that the basic methods should be preferred; rather, it often reflects the fear or ignorance by researchers and reviewers of newer, better performing methods.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Although much early research into statistical inference for matching was done for matching with replacement, the inference methods required highly specific uses of matching and complicated estimators of standard errors <span class="citation" data-cites="abadieLargeSampleProperties2006 abadieMatchingEstimatedPropensity2016">(<a href="references.html#ref-abadieLargeSampleProperties2006" role="doc-biblioref">Abadie and Imbens 2006</a>, <a href="references.html#ref-abadieMatchingEstimatedPropensity2016" role="doc-biblioref">2016</a>)</span>. The most applicable methods of inference for matching with replacement rely on simulation evidence and are only approximations <span class="citation" data-cites="hillIntervalEstimationTreatment2006">(<a href="references.html#ref-hillIntervalEstimationTreatment2006" role="doc-biblioref">Hill and Reiter 2006</a>)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./conceptual.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Conceptual aspects of the analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./assessing.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Assessing quality</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>